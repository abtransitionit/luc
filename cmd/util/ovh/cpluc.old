/*
Copyright Â© 2025 AB TRANSITION IT abtransitionit@hotmail.com
*/
package ovh

import (
	"fmt"
	"strings"

	"github.com/abtransitionit/luc/pkg/logx"
	"github.com/spf13/cobra"
)

// Description
var cplucOldSDesc = "build and deploy LUC in local then copy it on remote:"
var cplucOldLDesc = cplucOldSDesc + `
    - build LUC go CLI locally for current OS/platform (where the command is run)
    - locally deploy LUC to /usr/local/bin on the current OS/platform
    - build LUC go CLI locally for other platforms (i.e. OVH VMs :linux/amd64)
    - copy this LUC go CLI extra platform to remote OVH VM(s).
	`

var cplucOldCmd = &cobra.Command{
	Use:   "cplucOld OvhVm1 OvhVm2 ...",
	Short: cplucOldSDesc,
	Long:  cplucOldLDesc,
	Run: func(cmd *cobra.Command, args []string) {
		logx.L.Infof("%s", cplucOldSDesc)
		if !force {
			logx.L.Infof("use --force to run this command. also check --help for more details")
			return
		}

		// define CLI to build LUC locally and for platform linux/amd64 (ie. OVH VMs)
		localOutFilePath := "/tmp/luc"
		localOutLinuxAmdFilePath := "/tmp/luc-linux"

		cli := fmt.Sprintf(`
		cd /var/tmp/luc 							&& 
		rm -rf /tmp/luc* &> /dev/null &&  
		go build -o %s 					&& 
		sudo mv %s /usr/local/bin/luc && 
		GOOS=linux GOARCH=amd64 go build -o %s && cd -
		`, localOutFilePath, localOutFilePath, localOutLinuxAmdFilePath)

		logx.L.Debug("cli : %s ", cli)
		// play CLI
		logx.L.Debug("building LUC locally")
		// _, err := util.RunCLILocal(cli)
		// if err != nil {
		// 	logx.L.Debugf("%s", err)
		// }
		logx.L.Debug("builded LUC locally")

		// args denote OVH VMs
		if len(args) == 0 {
			return
		}

		// build ListAsString from args (ie. OvhVm1 OvhVm2 ...)
		var listVm = ""
		listVm = strings.Join(args, " ")
		nbVm := len(args)
		nbWorker := nbVm
		logx.L.Debug("nbWorker : %s ", nbWorker)

		logx.L.Debug("builded LUC locally")
		// copy LUC to OVH VMs
		remoteFilePath01 := "/tmp/luc"
		remoteFilePath02 := "/usr/local/bin/luc"
		logx.L.Debugf("copy LUC to (%d) OVH VMs: %s", nbVm, listVm)
		logx.L.Debugf("copy LUC to %s", remoteFilePath01)
		logx.L.Debugf("copy LUC to %s", remoteFilePath02)

	},
}

// var force bool

// func init() {
// 	cplucOldCmd.Flags().BoolVar(&force, "force", false, "Force execution even if not needed")
// }
